<!DOCTYPE html>
<html>
<head>
	<title></title>
	<style>
		body {
			padding: 20px;
		}
	</style>
</head>
<body>

<h1>Binding example</h1>

<p>
	<input type='text' id='text1'>
	<input type='text' id='text2'>
</p>

<p>
	<strong>RESULTS:</strong>
	<br>summ: <strong><span id='summ'></span></strong>
	<br>mult: <strong><span id='mult'></span></strong>
	<br>diff: <strong><span id='diff'></span></strong>
</p>

<script type="text/javascript" src="deps/jquery-2.1.1.min.js"></script>
<script>
$(document).ready(function(){

	var bounds = [];

	var bindToUI = function(mapperUI) {
		var execute = null,
			subscribers = [],
			self = this,
			mapper = null;

		//
		// Initial setup
		//
		if(mapperUI) {
			mapper = mapperUI;
			mapper.registerOnUpdateUI(setExecute);
		}

		//
		// Private section
		//
		function executeSubscribers() {
			for(var i=0; i<subscribers.length; i++) {
				setTimeout((function() {
					if(!isFunction(subscribers[i])) return;
					subscribers[i]();
				})(i));
			}
		}

		function setExecute(param) {
			if(isFunction(param)) {
				execute = param;
			} else {
				execute = function() { return param };
			}
			executeSubscribers();
		}

		function executeAndUpdateUI() {
			var res = execute();
			if(mapper && isFunction(mapper.onUpdateData)) {
				mapper.onUpdateData(res);
			}
			return res;
		}

		function subscriberExists(func) {
			for(var i=0; i<subscribers.length; i++) {
				if(func === subscribers[i]) {
					return true;
				}
			}

			return false;
		}

		//
		// Main function
		//
		var bound = function(param) {
			if(!param && !execute) {
				return;
			}

			if(!param && execute) {
				if(arguments.callee.caller && arguments.callee.caller.arguments.callee.caller) {
					var caller = arguments.callee.caller.arguments.callee.caller;

					for(var i=0; i<bounds.length; i++) {
						if(subscriberExists(caller)) continue;
						subscribers.push(caller);
					}
				}
				return executeAndUpdateUI();
			}

			setExecute(param);
			return executeAndUpdateUI();
		}

		bounds.push(bound);
		return bound;
	}

	//
	// Service methods
	//
	function isFunction(functionToCheck) {
		var getType = {};
		return functionToCheck && getType.toString.call(functionToCheck) === '[object Function]';
	}

	function defaultTextMapper(element) {
		var el = element;
		return {
			registerOnUpdateUI: function(onUpdateUI) {
				el.off();
				el.on('input', function() {
				    onUpdateUI(el.val());
				});
			},

			onUpdateData: function(val) {
				el.val(val);
			}
		}
	}

	function defaultSpanMapper(element) {
		var el = element;
		return {
			registerOnUpdateUI: function(onUpdateUI) {},
			onUpdateData: function(val) {
				el.text(val ? val : '0');
			}
		}
	}


	// MAIN
	var a = bindToUI( defaultTextMapper($('#text1')) ),
		b = bindToUI( defaultTextMapper($('#text2')) ),
		c = bindToUI( defaultSpanMapper($('#summ')) ),
		d = bindToUI( defaultSpanMapper($('#mult')) ),
		e = bindToUI( defaultSpanMapper($('#diff')) );

	a(1);
	b(2);
	c(function() { return parseInt(a()) + parseInt(b()) });
	d(function() { return parseInt(a()) * parseInt(b()) });
	e(function() { return parseInt(a()) - parseInt(b()) });

});
</script>
</body>
</html>